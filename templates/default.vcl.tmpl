vcl 4.0;

include "includes/backend.vcl";

import std;
import geoip;

{{ if getenv "VARNISH_IMPORT_MODULES" }}
{{ $modules := split (getenv "VARNISH_IMPORT_MODULES") "," }}
{{ range $modules }}import {{ . }};
{{ end }}{{ end }}

sub vcl_recv {
    # Varnish 6 already does it https://varnish-cache.org/docs/6.0/whats-new/upgrading-6.0.html
    {{ if contains (getenv "VARNISH_VER") "4." }}
    if (req.http.X-Forwarded-For) {
        set req.http.X-Forwarded-For = req.http.X-Forwarded-For + ", " + client.ip;
    } else {
        set req.http.X-Forwarded-For = client.ip;
    }
    {{ end }}

    set req.http.X-Real-IP = regsub(req.http.X-Forwarded-For, ".*\b(?!10|127)(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}).*", "\1");
    set req.http.X-Country-Code = geoip.country_code(req.http.X-Real-IP);
}

include "preset.vcl";

include "includes/purge.vcl";
include "includes/static.vcl";
include "includes/mobile.vcl";

# See https://book.varnish-software.com/4.0/chapters/VCL_Basics.html

include "defaults/vcl_recv.vcl";
include "defaults/vcl_hash.vcl";
include "defaults/vcl_pipe.vcl";
include "defaults/vcl_backend_response.vcl";
include "defaults/vcl_backend_error.vcl";
include "defaults/vcl_deliver.vcl";
